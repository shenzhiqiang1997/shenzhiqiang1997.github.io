<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="no one">
  <!-- Open Graph Data -->
  <meta property="og:title" content="tiny-spring-ioc-学习总结"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="no one&#39;s blog"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://henzhiqiang1997.github.io"/>
  
    <link rel="alternate" href="/atom.xml" title="no one&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>no one's blog</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">tiny-spring-ioc-学习总结</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/shenzhiqiang1997">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:1422537078@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By no one</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2018-04-11</span>
            <span class="time">20:40:43</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/Java/">Java</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/Java/">#Java</a> <a class="tag" href="/tags/IOC/">#IOC</a> <a class="tag" href="/tags/原理/">#原理</a> <a class="tag" href="/tags/设计模式/">#设计模式</a> <a class="tag" href="/tags/Spring/">#Spring</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h1 id="IOC容器实现相关"><a href="#IOC容器实现相关" class="headerlink" title="IOC容器实现相关"></a>IOC容器实现相关</h1><p>下面先简单介绍一下基本的类和接口</p>
<h2 id="数据源相关"><a href="#数据源相关" class="headerlink" title="数据源相关"></a>数据源相关</h2><p>继承与实现关系<br>Resource-&gt;UrlResource<br><a id="more"></a></p>
<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><p>定义了从数据源获取输入流的规范，用于从文件中获取输入流。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line">    <span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="UrlResource"><a href="#UrlResource" class="headerlink" title="UrlResource"></a>UrlResource</h3><p>实现了Resource接口，用于从统一资源定位符中获取输入流。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlResource</span> <span class="keyword">implements</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UrlResource</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">/* 从统一资源定位符中获取资源连接 */</span></span><br><span class="line">        URLConnection urlConnection = url.openConnection();</span><br><span class="line">        <span class="comment">/* 打开资源连接 */</span></span><br><span class="line">        urlConnection.connect();</span><br><span class="line">        <span class="comment">/* 从资源连接中获取输入流 */</span></span><br><span class="line">        <span class="keyword">return</span> urlConnection.getInputStream();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ResourceLoader"><a href="#ResourceLoader" class="headerlink" title="ResourceLoader"></a>ResourceLoader</h3><p>用于从给定路径中获取数据源并封装为统一定位资源。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span></span>&#123;</span><br><span class="line">        <span class="comment">/* 根据资源文件中的指定路径创建统一资源定位符 */</span></span><br><span class="line">        URL resource = <span class="keyword">this</span>.getClass().getClassLoader().getResource(location);</span><br><span class="line">        <span class="comment">/* 将资源定位符封装为统一定位资源 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UrlResource(resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Bean元数据相关"><a href="#Bean元数据相关" class="headerlink" title="Bean元数据相关"></a>Bean元数据相关</h2><h3 id="BeanDefiniton"><a href="#BeanDefiniton" class="headerlink" title="BeanDefiniton"></a>BeanDefiniton</h3><p>bean的元数据，包含bean的实例、Class名称、Class对象、属性等信息。用于之后创建bean实例，对bean的属性进行注入以及存放bean实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanDefinition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bean实例 */</span></span><br><span class="line">    <span class="keyword">private</span> Object bean;</span><br><span class="line">    <span class="comment">/* bean的Class对象 */</span></span><br><span class="line">    <span class="keyword">private</span> Class beanClass;</span><br><span class="line">    <span class="comment">/* bean的Class名称 */</span></span><br><span class="line">    <span class="keyword">private</span> String beanClassName;</span><br><span class="line">    <span class="comment">/* bean的属性 */</span></span><br><span class="line">    <span class="keyword">private</span> PropertyValues propertyValues = <span class="keyword">new</span> PropertyValues();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*在设置bean的Class名称时可以直接通过bean的Class名称获取到它的Class对象 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassName</span><span class="params">(String beanClassName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanClassName = beanClassName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.beanClass = Class.forName(beanClassName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 其他方法省略 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="PropertyValue与PropertyValues"><a href="#PropertyValue与PropertyValues" class="headerlink" title="PropertyValue与PropertyValues"></a>PropertyValue与PropertyValues</h3><p>bean的属性与属性列表，以键值对name-value的形式存储属性的名称与值，用于bean属性的注入。<br>值得一提的是value可以是另一个bean，此时value为beanReference类型来表示是bean的引用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyValue</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 属性名称 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">/* 属性值 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object value;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 其他方法省略 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 这里用一个类对属性列表进行封装 可以增加对属性列表的预处理 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyValues</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 属性列表 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;PropertyValue&gt; propertyValueList = <span class="keyword">new</span> ArrayList&lt;PropertyValue&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPropertyValue</span><span class="params">(PropertyValue pv)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span>这里可以对于重复propertyName进行判断，直接用list没法做到 */</span></span><br><span class="line">        <span class="keyword">this</span>.propertyValueList.add(pv);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 其他方法省略 */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="BeanReference"><a href="#BeanReference" class="headerlink" title="BeanReference"></a>BeanReference</h3><p>bean的引用，包含bean的名称与实例，用于对bean中的bean进行注入。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanReference</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* bean的名称 */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/* bean的实例 */</span></span><br><span class="line">    <span class="keyword">private</span> Object bean;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 其他方法省略 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Bean元数据读取相关"><a href="#Bean元数据读取相关" class="headerlink" title="Bean元数据读取相关"></a>Bean元数据读取相关</h2><p>继承与实现关系<br>BeanDefinitionReader-&gt;AbstractDefinitionReader-&gt;XmlBeanDefinitonReader</p>
<h3 id="BeanDefinitionReader"><a href="#BeanDefinitionReader" class="headerlink" title="BeanDefinitionReader"></a>BeanDefinitionReader</h3><p>bean元数据读取接口，定义了从指定路径的文件中中加载bean元数据的规范。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionReader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="AbstractBeanDefinitonReader"><a href="#AbstractBeanDefinitonReader" class="headerlink" title="AbstractBeanDefinitonReader"></a>AbstractBeanDefinitonReader</h3><p>抽象bean元数据读取类，实现了BeanDefinitonReader接口。<br>定义了ResourceLoader属性负责得到统一定义资源和registry属性(Map类型)来存放已经读取的bean元数据。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanDefinitionReader</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionReader</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 存放已注册的bean元数据 */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,BeanDefinition&gt; registry;</span><br><span class="line">    <span class="comment">/* 用于获取统一定位资源 */</span></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 其他方法省略 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="XmlBeanDefinitonReader"><a href="#XmlBeanDefinitonReader" class="headerlink" title="XmlBeanDefinitonReader"></a>XmlBeanDefinitonReader</h3><p>继承了AbstractBeanDefinitonReader，实现了从xml配置文件中加载bean元数据的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBeanDefinitionReader</span> <span class="keyword">extends</span> <span class="title">AbstractBeanDefinitionReader</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 调用父类构造器传入资源加载器 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XmlBeanDefinitionReader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(resourceLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">/* 用资源加载器从指定路径中的xml文件加载资源并获取输入流 */</span></span><br><span class="line">        InputStream inputStream = getResourceLoader().getResource(location).getInputStream();</span><br><span class="line">        <span class="comment">/* 从xml文件的输入流中解析xml文件得到bean的元数据</span></span><br><span class="line"><span class="comment">         *(即解析bean节点中的name节点、class节点和property节点</span></span><br><span class="line"><span class="comment">         * 以及property节点中name节点、value节点和ref节点 </span></span><br><span class="line"><span class="comment">         * 特殊的对于ref节点创建的属性值为BeanReference便于之后对bean的bean注入)</span></span><br><span class="line"><span class="comment">         *并将创建的所有BeanDefiniton对象将其暂时放入register中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        doLoadBeanDefinitions(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*对xml文件的解析操作方法省略 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="最基本的IOC容器"><a href="#最基本的IOC容器" class="headerlink" title="最基本的IOC容器"></a>最基本的IOC容器</h2><p>继承与实现关系<br>BeanFactory-&gt;AbstractBeanFactoryr</p>
<h3 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h3><p>bean工厂接口，定义了从IOC容器中获取bean的规范。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="AbstractBeanFactory"><a href="#AbstractBeanFactory" class="headerlink" title="AbstractBeanFactory"></a>AbstractBeanFactory</h3><p>抽象bean工厂，实现了BeanFacoty接口，实现了BeanFactory接口的getBean方法。<br>其中定义了一个Map属性来存放bean容器中所有bean的bean的元数据，定义了一个doCreateBeanDefintion模板方法留给子类实现，用于创建和初始化化bean。<br>另外一个重要的一点是暴露了bean元数据的注册接口，可以在BeanDefinitonReader读取了元数据之后将bean元数据注册到Map中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 用于存放bean的元数据 */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, BeanDefinition&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 用于存放bean的名称 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; beanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 实现了bean工厂接口的获取bean的方法 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        BeanDefinition beanDefinition = beanDefinitionMap.get(name);</span><br><span class="line">        <span class="keyword">if</span> (beanDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No bean named "</span> + name + <span class="string">" is defined"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** </span></span><br><span class="line"><span class="comment">         * 这里实现了bean的懒加载  </span></span><br><span class="line"><span class="comment">         * 如果已经IOC容器中已经有bean则直接获取  </span></span><br><span class="line"><span class="comment">         * 否则才创建并初始化bean</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line">        Object bean = beanDefinition.getBean();</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bean = doCreateBean(beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 暴露给外界用于注册bean元数据 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String name, BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        beanDefinitionMap.put(name, beanDefinition);</span><br><span class="line">        beanDefinitionNames.add(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 如果不想懒加载 该方法实现了bean容器的预加载  </span></span><br><span class="line"><span class="comment">     * 预先把容器中注册过的所有bean创建并初始化 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Iterator it = <span class="keyword">this</span>.beanDefinitionNames.iterator(); it.hasNext();) &#123;</span><br><span class="line">            String beanName = (String) it.next();</span><br><span class="line">            getBean(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 模板方法 用于创建和初始化bean 留给不同的子类实现 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">doCreateBean</span><span class="params">(BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="AutoCapableBeanFactory"><a href="#AutoCapableBeanFactory" class="headerlink" title="AutoCapableBeanFactory"></a>AutoCapableBeanFactory</h3><p>自动装配的bean工厂，继承自AbstractBeanFactory，实现了doCreateBean来实例化bean并初始化bean(为bean注入属性)。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">/* 先实例化bean */</span></span><br><span class="line">        Object bean = createBeanInstance(beanDefinition);</span><br><span class="line">        <span class="comment">/* 将bean置入相应的元数据中 以后通过map访问复用 */</span></span><br><span class="line">        beanDefinition.setBean(bean);</span><br><span class="line">        <span class="comment">/* 再为bean初始化 注入属性等 */</span></span><br><span class="line">        applyPropertyValues(bean, beanDefinition);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 从bean的元数据中得到Class来实例化一个bean */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createBeanInstance</span><span class="params">(BeanDefinition beanDefinition)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanDefinition.getBeanClass().newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 从bean的元数据中得到该bean的所有属性 通过反射来设置bean属性 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyPropertyValues</span><span class="params">(Object bean, BeanDefinition mbd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (PropertyValue propertyValue : mbd.getPropertyValues().getPropertyValues()) &#123;</span><br><span class="line">            Field declaredField = bean.getClass().getDeclaredField(propertyValue.getName());</span><br><span class="line">            declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object value = propertyValue.getValue();</span><br><span class="line">            <span class="comment">/* 如果属性值是另一个bean 则从bean容器中获取该bean再设置到bean中 */</span></span><br><span class="line">            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanReference) &#123;</span><br><span class="line">                BeanReference beanReference = (BeanReference) value;</span><br><span class="line">                value = getBean(beanReference.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            declaredField.set(bean, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="增强了的IOC容器"><a href="#增强了的IOC容器" class="headerlink" title="增强了的IOC容器"></a>增强了的IOC容器</h2><p>它是应用中直接使用的IOC容器<br>继承和实现关系<br>BeanFactory-&gt;ApplicationContext-&gt;AbstractApplicationContext-&gt;ClassPathXmlApplicationContext</p>
<h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><p>应用上下文接口，继承了BeanFactory接口，具有获取bean的能力。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContext</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="AbstractApplicationContext"><a href="#AbstractApplicationContext" class="headerlink" title="AbstractApplicationContext"></a>AbstractApplicationContext</h3><p>抽象应用上下文，实现了ApplicationContext接口。<br>ApplicationContext对BeanFacoty增强，可以认为是对BeanFactory代理，定义了BeanFacoty属性，直接利用它来注册bean的元数据和获取bean。<br>另外一个是定义了模板方法refresh()留给不同子类实现对bean元数据的读取和注册。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractApplicationContext</span> <span class="keyword">implements</span> <span class="title">ApplicationContext</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 对基本的IOC容器 BeanFactory进行增强 */</span></span><br><span class="line">    <span class="keyword">protected</span> AbstractBeanFactory beanFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 留给不同子类实现bean元数据的读取和注册 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 直接调用基本IOC容器来获取bean */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanFactory.getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*其他方法省略 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ClassPathXmlApplicationContext"><a href="#ClassPathXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext"></a>ClassPathXmlApplicationContext</h3><p>根据类路径中的Xml配置文件构建的应用上下文，继承自AbstractApplicationContext。<br>定义了一个configLocation属性用于定位xml文件在类路径中的地址，实现了refresh方法来从xml文件中读取bean元数据与注册。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathXmlApplicationContext</span> <span class="keyword">extends</span> <span class="title">AbstractApplicationContext</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* xml文件在类路径中的地址 */</span></span><br><span class="line">    <span class="keyword">private</span> String configLocation;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 这里直接使用自动装配的BeanFactory作为基础的IOC容器 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String configLocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(configLocation, <span class="keyword">new</span> AutowireCapableBeanFactory());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 这里在初始化ClassPathXmlApplicationContext  */</span></span><br><span class="line">    <span class="comment">/* 后会直接读取并注册所有bean元数据 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String configLocation, AbstractBeanFactory beanFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(beanFactory);</span><br><span class="line">        <span class="keyword">this</span>.configLocation = configLocation;</span><br><span class="line">        refresh();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 这部分是Application对BeanFacoty增强的主要部分</span></span><br><span class="line"><span class="comment">    * 将BeanFactory与BeanDefinitonReader结合起来工作</span></span><br><span class="line"><span class="comment">    * 这里会初始化一个XmlBeanDefinitonReader来从xml文件中读取bean的元数据</span></span><br><span class="line"><span class="comment">    * 之后再将读取到的所有bean数据注册到BeanFacoty中</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XmlBeanDefinitionReader xmlBeanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(<span class="keyword">new</span> ResourceLoader());</span><br><span class="line">        xmlBeanDefinitionReader.loadBeanDefinitions(configLocation);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, BeanDefinition&gt; beanDefinitionEntry : xmlBeanDefinitionReader.getRegistry().entrySet()) &#123;</span><br><span class="line">            beanFactory.registerBeanDefinition(beanDefinitionEntry.getKey(), beanDefinitionEntry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="IOC容器实现过程"><a href="#IOC容器实现过程" class="headerlink" title="IOC容器实现过程"></a>IOC容器实现过程</h2><p>为了方便描述，以下的分析全部用接口来描述相应的组件</p>
<ol>
<li>在指定了配置路径并初始化ApplicationContext后，将初始化BeanDefinitionReader来从相应文件中解析并读取bean的元数据。  </li>
<li>这之后将通过BeanFactory暴露的接口将所有读取到的bean的元数据注册到BeanFactory中的bean的元数据Map中存储（注意这个时候还没有实例化任何bean）。</li>
<li>当通过ApplicationContext的getBean尝试获取bean时，ApplicationContext将直接使用BeanFactory来获取bean，将会先检查bean已经在容器则直接获取并返回，否则将根据bean的元数据实例化和初始化bean。</li>
<li>当BeanFactory中没有相应的bean时，则会根据bean的元数据先实例化bean，这之后再根据元数据通过反射来为bean注入属性。当bean的属性为bean时，则会通过调用自身的getBean()来获取相应的bean之后再注入到属性中。（这里可以看到通过BeanFactoy通过懒加载和getBean避免了bean之间的循环依赖）</li>
<li>最后将会把初始化好的bean放置到相应bean的元数据中bean实例属性，以便之后再次获取时的复用，这之后再将bean返回给调用处就完成了一次bean的获取。</li>
</ol>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

